{% load static %}
<!--------------------- chatbot html start here ---------------------->
<div class="wrapper-chat">
    <div class="marvel-device nexus5" id="chat-bubble">
        <div class="screen">
        <div class="screen-container">

            <div class="chat-header" onclick="openChatBubble()">
            <div class="user-details">
                <img alt="gravater" class="dp" src={% static '/images/favicon.png' %}>
                <div class="detail-txt">
                    <span class="username">
                        MedHouse
                    </span>
                </div>
            </div>

            <div class="chat-options" onclick="openChatBubble()">
                <span> 
                    <i class="tf-ion-close-round"></i> 
                </span>
            </div>
            </div>

            <div class="chat-screen">
            <div class="chat">
                <!-- BEGINING OF MESSAGE-->
                <div class="container1 fixed rev">
                <ul class="message-body">
                    
                </ul>

                </div>
                <!-- END OF MESSAGE -->

                <!-- BEGINING OF INPUT BOTTOM -->
                <div class="chat-footer">
                <div class="bottom">
                    <form class="form">
                        <div class="sendMess" id="userInput ">
                            <button class="attachment"><i class="tf-ion-person"></i></button>
                            <textarea id="textInput" name="text" cols="20" rows="3" placeholder="enter your message">
                            </textarea>
                            <button class="send"><i class="tf-ion-android-send"></i></button>
                        </div>
                    </form>
                </div>
                </div>
                <!-- END OF INPUT BOTTOM-->
            </div>
            </div>
        </div>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>  
//chat bot
    window.onload = ()=>{
        reply("hi please type a message for me")
    } 

    $('.send').click(function(e){
        e.preventDefault();

        console.log($("#textInput").val());
        $.ajax({
            type: "POST",
            headers: {'X-CSRFToken': csrftoken},
            url: "/chatbot/",
            data: {
                question: $("#textInput").val().trim()
            },
            success: function(result) {
                msg=$("#textInput").val();
                reply(msg);

                // let li = document.createElement("li");
                // li.innerHTML = result.response;
                // li.classList.add("chatbox");
                // li.classList.add("chatbox-incoming");
                // $(".message-body").append(li);
                // scroll();

                // $(".message-body").append("<br>Me: "+$("#textInput").val()+ "<br> Karabo: "+result.response);
                // $("#textInput").val("")
            },
            error: function(result) {
                // alert('error');
                console.log(result);
            }
        });    
    });
    

    let counter = 0;
    const chatContainer = document.querySelector(".container");
    const chatArea = document.querySelector(".message-body");
    const text = document.querySelector("#textInput");
    const form = document.querySelector(".form");
    
    
    
    function openChatBubble() {
        var element = document.getElementById("chat-bubble");
        element.classList.toggle("open")
        }
        function isOverflown(element) {
        return (
          element.scrollHeight > element.clientHeight ||
          element.scrollWidth > element.clientWidth
        );
    }
     
    //EVENT LISTENERS
    text.addEventListener("focus", () => {
    chatContainer.scrollTop = chatArea.scrollHeight + 560;
    });


    function scroll() {
        chatArea.scroll(0,chatArea.scrollHeight);
    }

    function reply(msg) {
        let li = document.createElement("li");
        li.innerHTML = msg;
        li.classList.add("chatbox");
        li.classList.add("chatbox-incoming");
        chatArea.append(li);
        scroll();
    }
    
    form.addEventListener("submit", e => {
        e.preventDefault();
        msg = text.value;
        let li = document.createElement("li");
        li.innerHTML = msg;
        li.classList.add("chatbox");
        li.classList.add("chatbox-outgoing");
        chatArea.append(li);
        scroll();
        text.value = "";
        chatContainer.scrollTop =chatContainer.scrollHeight;
        text.focus();
        setTimeout(reply, 1000, messages[counter]);
        counter++;
        if (counter == messages.length) {
        counter = 0;
        }
    });

    function send(){
        msg = text.value;
        let li = document.createElement("li");
        li.innerHTML = msg;
        li.classList.add("chatbox");
        li.classList.add("chatbox-outgoing");
        chatArea.append(li);
        scroll();
        text.value = "";
        chatContainer.scrollTop =chatContainer.scrollHeight;
        text.focus();
        setTimeout(reply, 1000, messages[counter]);
        counter++;
        if (counter == messages.length) {
        counter = 0;
        }
    }
    

    // //buble body
    // const body = document.querySelector('body');

    // function getBotResponse() {
    //       var rawText = $("#textInput").val();
    //       var userHtml = '<p class="userText"><span>' + rawText + "</span></p>";
    //       $("#textInput").val("");
    //       $(".message-body").append(userHtml);
    //       document
    //         .getElementById("userInput")
    //         .scrollIntoView({ block: "start", behavior: "smooth" });
    //       $.get("/get", { msg: rawText }).done(function(data) {
    //         var botHtml = '<p class="botText"><span>' + data + "</span></p>";
    //         $("#.message-body").append(botHtml);
    //         document
    //           .getElementById("userInput")
    //           .scrollIntoView({ block: "start", behavior: "smooth" });
    //       });
    // }
    // $("#textInput").keypress(function(e) {
    //     if (e.which == 13) {
    //     getBotResponse();
    //     }
    // });

    
</script>
